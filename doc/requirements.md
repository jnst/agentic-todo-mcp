# 要件定義書

## 1. プロジェクト概要

### 目的
AIエージェントのコンテキスト記憶補助のためのMarkdownベースTodo管理システム

### 特徴
- AIエージェントの"物忘れ"防止
- 人間とAIの両方が読み書き可能
- プロジェクトの意思決定履歴（ADR）管理
- Model Context Protocol (MCP) 準拠

### 対象ユーザー
- AIアシスタント（Claude等）
- 開発者・プロジェクトマネージャー
- チームメンバー

## 2. データ管理方式

### 2.1 ディレクトリ構造
```
プロジェクトルート/
├── .todo/
│   ├── task.md          # 全タスクを1ファイルで管理
│   ├── context/         # コンテキスト情報（task-idと1:1対応）
│   │   ├── T001.md      # T001に対応するコンテキスト
│   │   ├── T002.md      # T002に対応するコンテキスト
│   │   └── ...
│   ├── adr/            # Architecture Decision Records
│   │   ├── adr-001-core-knowledge.md
│   │   ├── adr-002-techstack.md
│   │   └── ...
│   └── index.md        # 全体インデックス
```

### 2.2 Markdownファイル形式

#### タスクファイル例 (`task.md`)
```markdown
# Task

## SPEC
- [ ] 要件定義を作成 #T001
  - [ ] エラーハンドリング仕様確認
  - [x] レート制限設計完了

## Frontend
- [-] Reactコンポーネントを検討 #T002
  - [ ] UI設計
  - [-] プロトタイプ作成
  - [ ] ドキュメント更新

## Backend
- [ ] 外部API仕様確認 #T003
```

#### ADRファイル例 (`adr/adr-001-markdown-storage.md`)
```markdown
# ADR-001: Markdownベースのデータストレージ選択

## Status
Accepted

## Date
2025-01-15

## Context
AIエージェントのコンテキスト記憶補助システムにおいて、データの永続化方式を決定する必要がある。

## Decision
プロジェクトルートの `.todo/` ディレクトリ配下にMarkdownファイルで管理する。

## Rationale
- 人間とAIの両方が読み書き可能
- Git管理しやすい
- プレーンテキストで検索・編集が容易
- バックアップ・復元が簡単

## Consequences
### Positive
- 透明性とアクセシビリティの向上
- バージョン管理との親和性
- ツール非依存

### Negative
- 大量データの場合のパフォーマンス課題
- 構造化データクエリの複雑さ
```


## 3. 機能要件

### 3.1 タスク管理機能
- **main-task作成**: task.md内への新規main-taskエントリ追加、対応するcontextファイル作成
- **タスク更新**: task.md内の特定タスクエントリの部分更新（内容、ステータス）
- **タスク検索**: task.md内容およびcontext情報を含む柔軟な検索
- **依存関係管理**: タスク間の関連性追跡・可視化
- **コンテキスト情報**: task-idと1:1で対応するコンテキストファイル管理
- **sub-task管理**: チェックリスト形式でのsub-task管理
- **同期削除**: main-task削除時、対応するcontextファイルも同時削除
- **優先度管理**: 位置ベースの優先度管理（上位ほど高優先度）
- **category管理**: 任意の名称でタスクを分類


### 3.2 ADR管理機能
- **決定事項記録**: Architecture Decision Recordsの標準形式管理
- **履歴追跡**: 決定の変更履歴・ステータス管理
- **影響分析**: 決定がタスクに与える影響の追跡
- **検索・参照**: 過去の決定事項の効率的な検索

### 3.3 コンテキスト管理機能
- **1:1紐付け**: 各main-taskに対して同じtask-idのcontextファイルを管理
- **決定履歴**: main-taskに関する意思決定記録
- **知識蓄積**: main-task作業中に得られた知識や知見を記録
- **整合性管理**: main-taskとcontextファイルの同期管理

## 4. MCPツール仕様

### 4.1 タスク管理ツール

#### `create_task`
- **目的**: 新規main-task作成
- **入力**: タイトル、説明等
- **出力**: 作成されたtask-id、ファイルパス

#### `update_task`
- **目的**: 既存taskの更新
- **入力**: task-id、更新内容（部分更新対応）
- **出力**: 更新結果、更新日時

#### `list_tasks`
- **目的**: タスク一覧取得（フィルタ対応）
- **入力**: ステータス、category等のフィルタ
- **出力**: 条件に合致するタスクリスト

#### `search_tasks`
- **目的**: 全文検索による柔軟なタスク検索
- **入力**: 検索クエリ、検索対象（タイトル、内容等）
- **出力**: 関連度順のタスクリスト

#### `link_tasks`
- **目的**: タスク間の関連付け・依存関係設定
- **入力**: 元task-id、関連task-id、関連タイプ
- **出力**: 関連付け結果


### 4.2 ADR管理ツール

#### `create_adr`
- **目的**: 新規ADR作成
- **入力**: タイトル、コンテキスト、決定内容、理由、影響
- **出力**: ADR ID、ファイルパス

#### `update_adr_status`
- **目的**: ADRステータス更新（Proposed → Accepted → Deprecated等）
- **入力**: ADR ID、新ステータス、理由
- **出力**: 更新結果

#### `list_adrs`
- **目的**: ADR一覧取得
- **入力**: ステータス、日付範囲等のフィルタ
- **出力**: ADRリスト

### 4.3 コンテキスト管理ツール

#### `update_context`
- **目的**: main-taskにcontext情報追加・更新
- **入力**: task-id、context内容、contextタイプ
- **出力**: 更新結果

#### `get_context`
- **目的**: main-taskのcontext情報取得
- **入力**: task-id
- **出力**: 対応するcontextファイル内容

#### `search_contexts`
- **目的**: 全contextファイルの検索
- **入力**: 検索クエリ
- **出力**: マッチしたtask-idとcontext内容のリスト

### 4.4 MCPリソース

#### ファイルリソース
1. `file://.todo/index.md` - 全体インデックス
2. `file://.todo/task.md` - 全タスク
3. `file://.todo/adr/adr-{number}-{title}.md` - 個別ADR
4. `file://.todo/context/{task-id}.md` - 個別コンテキスト（task-idと同じ）

## 5. 技術要件

### 5.1 ファイル操作
- **Markdownパース**: シンプルなMarkdownチェックリスト形式の解析
- **ファイル監視**: 外部変更の検知とリアルタイム同期
- **整合性管理**: main-taskとcontextファイルの1:1対応管理
- **インデックス管理**: 高速検索のためのインメモリインデックス
- **バリデーション**: ファイル形式・task-id形式の整合性チェック
- **バックアップ**: 自動バックアップ機能

### 5.2 検索・フィルタリング
- **category検索**: categoryによる検索
- **全文検索**: タスク・ADR・コンテキスト内容の全文検索
- **関連性検索**: 関連タスク・ADR・コンテキストの発見
- **task-id検索**: 特定のtask-idによる検索
- **複合検索**: 複数条件の組み合わせ検索

### 5.3 パフォーマンス
- **応答時間**: 通常操作100ms以内、検索操作500ms以内
- **ファイル数**: 10,000ファイルまでの効率的な処理
- **メモリ使用量**: 適切なメモリ管理とガベージコレクション
- **並行処理**: 複数セッションの同時処理対応

## 6. AIエージェント支援機能

### 6.1 コンテキスト保持
- **セッション記憶**: 長期間にわたる作業の継続性保証
- **決定履歴**: 過去の判断基準・決定事項の参照
- **進捗追跡**: 作業の中断・再開時の状況完全把握


## 8. 制約・前提条件

### 8.1 技術制約
- Go 1.24以上の使用
- modelcontextprotocol/go-sdk の使用
- ローカルファイルシステムへの読み書き権限必要
- .todoディレクトリの作成・管理権限必要

### 8.2 運用制約
- プロジェクトルートでの実行前提
- Markdownファイル形式の遵守必要
- Git管理下での使用推奨（任意）

## 9. 成功基準

### 9.1 機能面
- 全MCPツールの正常動作
- Markdownファイルの適切な生成・更新
- 検索・フィルタリング機能の高速動作
- AIエージェントによる継続的なコンテキスト利用

### 9.2 非機能面
- 応答時間要件の満足
- データ整合性の保証
- エラー処理の適切性
- ドキュメントの完全性

### 9.3 ユーザビリティ
- AIエージェントによる直感的な操作
- 人間による直接的なファイル編集の容易性
- 他ツールとの連携性
- 学習コストの低さ
